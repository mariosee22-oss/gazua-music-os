<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gazua Music OS: 멀티모달 음악 창작 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #5B21B6; /* Deep Violet */
            --secondary-color: #8B5CF6; /* Lighter Violet */
            --bg-color: #0F172A; /* Slate 900 */
            --card-color: #1E293B; /* Slate 800 */
            --text-color: #E2E8F0; /* Slate 200 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            width: 100%;
        }
        .card {
            background-color: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
        }
        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            transform: translateY(-1px);
        }
        .btn:disabled {
            background-color: #475569; /* Slate 600 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .input-group label {
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        /* --- [수정] 입력 필드 색상 일관성 확보 --- */
        textarea, input[type="text"], input[type="number"], select {
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            color: #E2E8F0; /* Text Color */
            padding: 0.75rem;
            border-radius: 6px;
            width: 100%;
        }
        /* --- [수정 끝] --- */
        .progress-bar {
            background-color: #475569;
            border-radius: 9999px;
            height: 8px;
            overflow: hidden;
        }
        .progress-fill {
            background-color: #3B82F6; /* Blue 500 */
            height: 100%;
            transition: width 0.3s ease;
        }
        /* Custom scrollbar for chat/log */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--card-color);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748B;
        }
        .log-entry {
            border-left: 3px solid var(--secondary-color);
            padding-left: 0.75rem;
            margin-bottom: 0.75rem;
            background-color: #1E293B;
            padding: 0.5rem;
            border-radius: 4px;
        }
        /* --- [수정] Gemini 출력 및 로그 컨테이너 배경색 변경 --- */
        #geminiOutput, #processLog {
            background-color: #111827; /* Darker background for content boxes */
        }
    </style>
</head>
<body>
    <div class="container py-8">
        <h1 class="text-4xl font-extrabold text-center mb-10 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
            <i class="fas fa-headphones-alt"></i> Gazua Music OS: 멀티모달 음악 창작
        </h1>

        <!-- 전체 레이아웃: 입력/설정 + 결과/로그 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- 1. 입력 및 설정 (Input & Configuration) -->
            <div class="lg:col-span-1 space-y-6">
                <!-- [수정] space-space-y-4 오타 수정 -->
                <div class="card space-y-4">
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2"><i class="fas fa-sliders-h"></i> 음악 생성 설정</h2>
                    
                    <div class="input-group">
                        <label for="musicStyle">음악 스타일/장르:</label>
                        <input type="text" id="musicStyle" placeholder="예: Epic Orchestral, Synthwave, K-Pop Ballad">
                    </div>
                    
                    <div class="input-group">
                        <label for="mood">분위기/감정:</label>
                        <input type="text" id="mood" placeholder="예: 희망찬, 긴장감 있는, 몽환적인">
                    </div>

                    <div class="input-group">
                        <label for="lyricTheme">가사 테마 (선택 사항):</label>
                        <input type="text" id="lyricTheme" placeholder="예: 우주 여행, 첫사랑의 설렘, 도시의 밤">
                    </div>
                    
                    <div class="input-group">
                        <label for="duration">음악 길이 (초):</label>
                        <input type="number" id="duration" value="30" min="10" max="180">
                    </div>
                    
                    <div class="input-group">
                        <label for="engineMode">사용할 AI 엔진 모드:</label>
                        <select id="engineMode" class="w-full">
                            <option value="gemini">Gemini (프롬프트/컨셉 기획)</option>
                            <!-- [업데이트] 엔진 어댑터 구현을 위해 Suno/Stable Audio 옵션 활성화 -->
                            <option value="suno">Suno (음악 생성 어댑터)</option>
                            <option value="stable-audio">Stable Audio (음악 생성 어댑터)</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="btn w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-magic"></i> <span>음악 컨셉 및 프롬프트 생성 시작</span>
                    </button>
                    <div id="loadingIndicator" class="hidden text-center mt-4">
                        <i class="fas fa-spinner fa-spin text-secondary-color text-2xl"></i>
                        <p class="mt-2 text-sm">Gemini가 최적의 음악 컨셉을 기획 중입니다...</p>
                    </div>
                </div>

                <!-- 프롬프트 출력 카드 -->
                <div class="card space-y-4">
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2"><i class="fas fa-music"></i> 최종 스타일 프롬프트 (Suno/Stable Audio용)</h2>
                    <textarea id="finalPromptOutput" rows="5" class="text-xs" readonly placeholder="Suno/Stable Audio 엔진의 '스타일 입력창'에 직접 전달될 간결한 스타일 지침이 여기에 추출됩니다."></textarea>
                    <button id="copyPromptBtn" class="btn w-full text-sm disabled:opacity-50" disabled><i class="fas fa-copy"></i> 스타일 프롬프트 복사</button>
                </div>

                <!-- [추가] 가사 출력 카드 -->
                <div class="card space-y-4">
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2"><i class="fas fa-microphone"></i> 최종 가사 프롬프트 (Lyrics)</h2>
                    <textarea id="lyricPromptOutput" rows="5" class="text-xs" readonly placeholder="Suno/Udio의 '가사 입력창'에 직접 전달될 완성된 가사가 여기에 추출됩니다."></textarea>
                    <!-- [수정] 초기 disabled 속성 추가 -->
                    <button id="copyLyricPromptBtn" class="btn w-full text-sm disabled:opacity-50" disabled><i class="fas fa-copy"></i> 가사 프롬프트 복사</button>
                </div>
                <!-- [추가 끝] -->
            </div>

            <!-- 2. 결과 및 로그 (Output & Log) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Gemini 응답 카드 (컨셉 기획 결과) -->
                <div class="card space-y-4">
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2"><i class="fas fa-robot"></i> Gemini 음악/뮤비 컨셉 기획 결과 (OS 두뇌)</h2>
                    <div id="geminiOutput" class="custom-scrollbar h-80 overflow-y-auto p-2 bg-gray-800 rounded-lg text-sm whitespace-pre-wrap" placeholder="Gemini의 음악 컨셉 기획 결과가 여기에 표시됩니다.">
                        Gemini에 최적화된 프롬프트가 여기에 표시됩니다. 이 컨셉을 바탕으로 Suno나 Stable Audio 같은 전문 AI 엔진에 전달될 최종 프롬프트가 생성됩니다.
                    </div>
                </div>
                
                <!-- [추가] 이미지/뮤비 프롬프트 출력 카드 -->
                <div class="card space-y-4">
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2"><i class="fas fa-camera-movie"></i> 최종 시각 컨셉 프롬프트 (DALL-E/Midjourney용)</h2>
                    <textarea id="visualPromptOutput" rows="5" class="text-xs" readonly placeholder="뮤직비디오에 사용될 이미지/동영상 생성을 위한 최적화된 시각 프롬프트가 여기에 추출됩니다."></textarea>
                    <!-- [수정] 초기 disabled 속성 추가 -->
                    <button id="copyVisualPromptBtn" class="btn w-full text-sm disabled:opacity-50" disabled><i class="fas fa-copy"></i> 시각 프롬프트 복사</button>
                </div>
                <!-- [추가 끝] -->

                <!-- 진행 상황 및 로그 카드 (Progress & Log) -->
                <!-- [수정] space-space-y-4 오타 수정 -->
                <div class="card space-y-4">
                    <h2 class="text-xl font-bold border-b border-gray-700 pb-2"><i class="fas fa-clipboard-list"></i> 진행 상황 로그</h2>
                    <div class="progress-bar mb-4">
                        <div id="progressBarFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <!-- 로그 컨테이너 배경색 수정 완료 -->
                    <div id="processLog" class="custom-scrollbar h-40 overflow-y-auto text-xs space-y-2">
                        <!-- 로그 항목이 여기에 추가됩니다 -->
                        <div class="log-entry"><strong>[시스템]</strong> Gazua Music OS 가동 준비 완료.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ---------------------------------------------------------------------------------------------------------------------------------- -->
    <!-- [핵심 로직 블록] - 단일 파일 내 논리적 분리 영역 -->
    <!-- ---------------------------------------------------------------------------------------------------------------------------------- -->
    <script type="text/javascript" id="core-logic">
        // API 키는 이 환경에서 자동으로 제공되거나, 필요에 따라 사용자에게 입력받을 수 있습니다.
        const API_KEY = ""; // 캔버스 환경에서 자동으로 채워집니다.

        /**
         * 로그를 UI에 추가하고 콘솔에 출력합니다.
         * @param {string} message - 출력할 메시지
         * @param {string} level - 로그 레벨 ('info', 'error', 'success')
         */
        function logProcess(message, level = 'info') {
            const logContainer = document.getElementById('processLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry text-gray-300';
            
            let icon = '<i class="fas fa-info-circle text-blue-400"></i>';
            let color = 'border-blue-400';

            if (level === 'error') {
                icon = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
                color = 'border-red-500';
            } else if (level === 'success') {
                icon = '<i class="fas fa-check-circle text-green-500"></i>';
                color = 'border-green-500';
            } else if (level === 'step') {
                icon = '<i class="fas fa-arrow-right text-yellow-400"></i>';
                color = 'border-yellow-400';
            }

            entry.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
            entry.className += ` ${color}`;
            logContainer.prepend(entry);
            
            // 로그가 15개를 초과하면 오래된 로그 제거
            if (logContainer.children.length > 15) {
                logContainer.lastChild.remove();
            }

            console.log(`[${level.toUpperCase()}] ${message}`);
        }

        /**
         * 진행률 바를 업데이트합니다.
         * @param {number} percentage - 진행률 (0-100)
         */
        function updateProgress(percentage) {
            const fill = document.getElementById('progressBarFill');
            fill.style.width = `${percentage}%`;
        }

        /**
         * Gemini에 최적화된 프롬프트를 컨텍스트로부터 생성합니다.
         * 이 함수는 복잡한 다중 컨텍스트 기획을 담당합니다.
         * * @param {Object} context - 사용자 입력 값 객체
         * @returns {Object} - Gemini에 전달할 {systemInstruction, userQuery} 객체
         */
        function buildPromptForGemini(context) {
            logProcess('단계 1.1: Gemini 컨셉 기획용 상세 주문서 작성.', 'step');
            
            const { musicStyle, mood, lyricTheme, duration } = context;
            
            // --- [음악 다양성 강제 로직 추가] ---
            const diversityRule = `
                - DIVERSITY ENFORCEMENT: Avoid generic lofi/ambient textures. Use unique, challenging sound sources (e.g., experimental synth patches, tape noise, field recordings, 8-bit samples) to create a distinctive, non-generic soundscape.
                - STRUCTURAL IRREGULARITY: Avoid simple A-B-A structure. Introduce unexpected mood shifts or rhythmic breaks to prevent the music from becoming repetitive background filler.
                - MOOD CONTRAST: When mood and style clash (e.g., 'Angry' Orchestral), emphasize the dramatic tension in the resulting sound design.
            `;
            // --- [다양성 로직 끝] ---


            // 1. 시스템 지침: Gemini의 역할을 정의합니다. (4가지 항목 모두 생성 요청 - 가사 추가)
            const systemInstruction = `
                당신은 세계 최고의 음악/뮤직비디오 컨셉 기획자(Concept Planner)입니다.
                사용자의 요청을 분석하여, 다음 4가지 항목을 포함하는 상세하고 창의적인 컨셉 기획서를 작성해야 합니다.
                
                1. **[컨셉 요약]**: 음악의 전체적인 분위기와 주제를 2줄 이내로 요약합니다.
                2. **[최종 가사 프롬프트]**: '${lyricTheme}' 테마를 기반으로, '${musicStyle}'와 '${mood}'에 맞는 감성을 담은 **실제 가사(Lyrics)**를 작성합니다. 가사는 [Verse 1], [Chorus], [Verse 2], [Bridge], [Chorus] 구조를 가지며, 모든 내용은 한글로 작성되어야 합니다. **(중요: 선정적인 내용, 욕설, 아티스트 이름 언급은 절대 포함하지 마십시오. 상업적 이용 가능해야 합니다.)**
                3. **[최종 스타일 프롬프트]**: Suno 또는 Stable Audio와 같은 전문 AI 음악 생성기에 전달할, 구체적이고 예술적인 150단어 내외의 **최종 음악 스타일 명령어**를 작성합니다.
                4. **[뮤직비디오 컨셉]**: 이 음악의 템포와 무드에 완벽하게 동기화되는 1080p 해상도의 **시각적 컨셉 프롬프트**를 5줄 이내로 서술합니다. (장소, 분위기, 주요 장면)
                
                **제약 조건:**
                - 출력은 이 지침의 4가지 항목(컨셉 요약, 최종 가사 프롬프트, 최종 스타일 프롬프트, 뮤직비디오 컨셉)만 포함해야 하며, 다른 서론이나 결론은 절대 포함하지 마십시오.
                - 최종 출력 포맷은 다음과 같아야 합니다 (헤더 포함):
                  [컨셉 요약]
                  {요약 내용}
                  
                  [최종 가사 프롬프트]
                  {가사 내용 - 한글}

                  [최종 스타일 프롬프트]
                  {스타일 명령어 내용 - 영어}
                  
                  [뮤직비디오 컨셉]
                  {시각적 컨셉 내용}
            `.trim();

            // 2. 사용자 질의: 사용자의 세부 요구사항을 전달합니다. (다양성 로직 주입)
            const userQuery = `
                다음 요소를 기반으로 음악 기획서를 작성해 주세요:
                - **음악 스타일/장르**: ${musicStyle || '미정'}
                - **분위기/감정**: ${mood || '미정'}
                - **가사 테마**: ${lyricTheme || '없음'}
                - **음악 길이**: ${duration}초
                
                프롬프트는 '${musicStyle}'와 '${mood}'를 강조하여 작성해 주세요.
                
                ---
                **[다양성 강제 지침 - 이 부분을 반드시 반영하여 창의성을 높여주세요]**
                ${diversityRule.trim()}
            `.trim();

            return {
                systemInstruction: systemInstruction,
                userQuery: userQuery
            };
        }
        
        /**
         * [추가] Gemini 응답에서 특정 섹션의 내용을 추출하는 유틸리티 함수
         * @param {string} responseText - Gemini 전체 응답 텍스트
         * @param {string} sectionName - 추출할 섹션의 이름 (예: '[Gemini용 프롬프트]')
         * @returns {string} - 추출된 내용 또는 에러 메시지
         */
        function extractSection(responseText, sectionName) {
            if (typeof responseText !== 'string' || typeof sectionName !== 'string') {
                return `[${sectionName || '섹션'} 추출 실패: 입력 누락]`;
            }

            const normalizeKey = (value) => value.replace(/\s+/g, '').toLowerCase();
            const targetKey = normalizeKey(sectionName);

            // 1) 줄바꿈 통일 및 트림
            const normalizedText = responseText.replace(/\r\n?/g, '\n').trim();
            const lines = normalizedText.split('\n');

            // 2) 헤더를 탐색하며 섹션을 맵으로 구성
            const sectionMap = new Map();
            let currentKey = null;

            lines.forEach((line) => {
                const headerMatch = line.match(/^\s*\[(.+?)\]\s*$/);
                if (headerMatch) {
                    const headerLabel = `[${headerMatch[1].trim()}]`;
                    currentKey = normalizeKey(headerLabel);
                    if (!sectionMap.has(currentKey)) {
                        sectionMap.set(currentKey, []);
                    }
                    return;
                }

                if (currentKey) {
                    sectionMap.get(currentKey).push(line);
                }
            });

            // 3) 대상 섹션 추출
            const targetContent = sectionMap.get(targetKey);

            if (!targetContent || targetContent.length === 0) {
                return `[${sectionName} 추출 실패: 섹션을 찾을 수 없습니다.]`;
            }

            const content = targetContent.join('\n').trim();

            if (!content) {
                return `[${sectionName} 추출 실패: 내용이 비어 있음]`;
            }

            return content;
        }



        /**
         * (Engine Adapter)
         * 지정된 엔진 모드에 따라 최종 프롬프트 추출 로직을 분기하고 실행합니다.
         * @param {string} engineMode - 사용할 엔진 모드 ('gemini', 'suno', 'stable-audio')
         * @param {Object} context - 사용자 입력 값 객체
         */
        async function runEngineAdapter(engineMode, context) {
            logProcess(`단계 2.1: 선택된 엔진 어댑터(${engineMode}) 실행 준비...`, 'step');
            
            try {
                // 1. Gemini에게 컨셉 기획 요청 (모든 모드에서 필수)
                const { systemInstruction, userQuery } = buildPromptForGemini(context);
                const geminiResponse = await callGeminiApi(systemInstruction, userQuery, 'concept');

                // 2. 음악 관련 프롬프트 추출 (이제 인덱스 기반으로 안정화됨)
                const finalMusicPrompt = extractSection(geminiResponse, '[최종 스타일 프롬프트]');
                const finalLyricPrompt = extractSection(geminiResponse, '[최종 가사 프롬프트]'); 
                
                // 3. 시각 관련 프롬프트 추출
                const visualConcept = extractSection(geminiResponse, '[뮤직비디오 컨셉]');
                
                // 4. UI 업데이트
                
                // A. Suno/Stable Audio 모드: 스타일과 가사를 분리하여 출력
                if (engineMode === 'suno' || engineMode === 'stable-audio') {
                    
                    document.getElementById('finalPromptOutput').value = finalMusicPrompt;
                    document.getElementById('lyricPromptOutput').value = finalLyricPrompt;
                    
                    // [수정] 복사 버튼 활성화 로직
                    if (finalMusicPrompt.length > 10) document.getElementById('copyPromptBtn').disabled = false;
                    if (finalLyricPrompt.length > 10) document.getElementById('copyLyricPromptBtn').disabled = false;
                    
                    logProcess(`[${engineMode.toUpperCase()} 어댑터] 스타일 및 가사 프롬프트 추출 완료.`, 'success');
                } else {
                    // Gemini 모드 선택 시, 최종 프롬프트에는 스타일+가사 합본을 표시하여 전체 복사 용이하게 함
                    document.getElementById('finalPromptOutput').value = finalMusicPrompt + "\n\n--- [가사 시작] ---\n" + finalLyricPrompt;
                    document.getElementById('lyricPromptOutput').value = finalLyricPrompt; // 가사 분리 출력 유지
                    
                    // [수정] 복사 버튼 활성화 로직
                    if (finalMusicPrompt.length > 10) document.getElementById('copyPromptBtn').disabled = false;
                    if (finalLyricPrompt.length > 10) document.getElementById('copyLyricPromptBtn').disabled = false;

                    logProcess(`[GEMINI 모드] 상세 기획서 작성이 완료되었습니다.`, 'success');
                }
                
                // B. 시각 콘텐츠 어댑터 로직 실행
                // 최종 시각 프롬프트를 Midjourney/DALL-E에 최적화
                const optimizedVisualPrompt = `8K, Cinematic, High Contrast, Digital Art, Full Frame, Aspect Ratio 16:9, Style ${visualConcept}`;
                document.getElementById('visualPromptOutput').value = optimizedVisualPrompt;
                
                // [수정] 복사 버튼 활성화 로직
                if (visualConcept.length > 10) document.getElementById('copyVisualPromptBtn').disabled = false;
                
                logProcess('시각 콘텐츠 어댑터: 뮤비/이미지 프롬프트 추출 및 최적화 완료.', 'success');

                updateProgress(100);

            } catch (error) {
                logProcess(`[치명적 오류] 엔진 어댑터 실행 중 오류 발생: ${error.message}`, 'error');
                updateProgress(0);
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('generateBtn').disabled = false;
            }
        }

        /**
         * Gemini API를 호출하여 음악 컨셉 기획서를 가져옵니다.
         * @param {string} systemInstruction - Gemini 시스템 지침
         * @param {string} userQuery - 사용자 질의
         * @param {string} mode - 'music' 또는 'concept'
         * @returns {string} - Gemini 응답 텍스트 전체 (성공 시)
         */
        async function callGeminiApi(systemInstruction, userQuery, mode) {
            logProcess(`단계 3.1: Gemini API 호출 시작 (모드: ${mode})...`, 'step');
            updateProgress(50);
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            for (let i = 0; i < 3; i++) { // Max 3 retries
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API 응답 오류: ${response.status} - ${errorBody.error?.message || '알 수 없는 오류'}`);
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!generatedText) {
                        throw new Error("Gemini에서 유효한 텍스트 응답을 받지 못했습니다.");
                    }

                    // 응답 처리 (성공 시)
                    document.getElementById('geminiOutput').innerText = generatedText;
                    logProcess('단계 4.1: Gemini 컨셉 기획 완료 및 응답 수신 성공.', 'success');
                    updateProgress(100);
                    return generatedText; // 성공 시 텍스트 반환

                } catch (error) {
                    logProcess(`[API 오류] ${i + 1}차 시도 실패: ${error.message}`, 'error');
                    if (i === 2) {
                        // 최종 실패
                        document.getElementById('geminiOutput').innerText = `API 호출 최종 실패: ${error.message}`;
                        throw new Error("API 호출이 최종적으로 실패했습니다. 로그를 확인하세요.");
                    }
                    // 지수 백오프
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        /**
         * Gemini 응답 텍스트를 파싱하여 UI에 업데이트합니다.
         * (Note: 이 함수는 더 이상 runEngineAdapter에서 직접 사용되지 않지만, 다른 모드에서는 필요할 수 있음)
         * @param {string} responseText - Gemini에서 받은 텍스트
         */
        function processGeminiResponse(responseText) {
            const geminiOutput = document.getElementById('geminiOutput');
            const finalPromptOutput = document.getElementById('finalPromptOutput');

            // 1. Gemini 기획서 전체를 UI에 표시
            geminiOutput.innerText = responseText;
            
            // 2. [최종 스타일 프롬프트] 추출 (임시)
            const promptRegex = /\[최종 스타일 프롬프트\]\s*([\s\S]*?)(?=\[|$)/i;
            const match = responseText.match(promptRegex);
            
            let finalPrompt = "프롬프트 추출 실패. [최종 스타일 프롬프트] 섹션을 수동으로 복사하세요.";
            if (match && match[1]) {
                finalPrompt = match[1].trim();
            }

            // 3. 최종 프롬프트 및 복사 버튼 업데이트
            finalPromptOutput.value = finalPrompt;
            document.getElementById('copyPromptBtn').disabled = false;
        }

        // --------------------------------------------------------------------------------------
        // API 통신 후 UI 정리
        // --------------------------------------------------------------------------------------
        function finalizeUI(enable) {
            document.getElementById('generateBtn').disabled = !enable;
            document.getElementById('loadingIndicator').classList.toggle('hidden', enable);
        }

        // --------------------------------------------------------------------------------------
        // 메인 이벤트 리스너 함수
        // --------------------------------------------------------------------------------------
        async function handleGenerateClick() {
            const musicStyle = document.getElementById('musicStyle').value.trim();
            const mood = document.getElementById('mood').value.trim();
            const lyricTheme = document.getElementById('lyricTheme').value.trim();
            const duration = parseInt(document.getElementById('duration').value, 10);
            const engineMode = document.getElementById('engineMode').value;

            if (!musicStyle || !mood || isNaN(duration) || duration < 10) {
                logProcess('오류: 음악 스타일, 분위기, 길이(10초 이상)는 필수 입력 사항입니다.', 'error');
                return;
            }

            // UI 정리 및 시작
            document.getElementById('geminiOutput').innerText = '';
            document.getElementById('finalPromptOutput').value = '';
            document.getElementById('lyricPromptOutput').value = '';
            document.getElementById('visualPromptOutput').value = '';
            document.getElementById('copyPromptBtn').disabled = true;
            document.getElementById('copyLyricPromptBtn').disabled = true;
            document.getElementById('copyVisualPromptBtn').disabled = true;
            finalizeUI(false); // 버튼 비활성화, 로딩 시작
            updateProgress(10);
            logProcess('--- 새로운 음악/미디어 기획 시작 ---', 'info');

            const context = { musicStyle, mood, lyricTheme, duration };
            
            try {
                // 논리적 분리: 모든 핵심 로직을 runEngineAdapter를 통해 실행
                await runEngineAdapter(engineMode, context);
            } catch (e) {
                logProcess(`작업 중 최종 오류: ${e.message}`, 'error');
            } finally {
                finalizeUI(true); // 버튼 활성화, 로딩 종료
            }
        }
    </script>

    <!-- ---------------------------------------------------------------------------------------------------------------------------------- -->
    <!-- [메인 UI 및 이벤트 핸들링 블록] - UI 상호작용만 담당 -->
    <!-- ---------------------------------------------------------------------------------------------------------------------------------- -->
    <script type="text/javascript" id="main-ui-events">
        document.addEventListener('DOMContentLoaded', () => {
            const generateBtn = document.getElementById('generateBtn');
            const copyPromptBtn = document.getElementById('copyPromptBtn');
            const copyLyricPromptBtn = document.getElementById('copyLyricPromptBtn'); // 가사 복사 버튼 요소
            const copyVisualPromptBtn = document.getElementById('copyVisualPromptBtn'); // 시각 복사 버튼 요소

            // 1. 생성 버튼 이벤트: 핵심 로직 블록의 함수 호출
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGenerateClick);
            }

            // 2. 스타일 프롬프트 복사 이벤트
            if (copyPromptBtn) {
                copyPromptBtn.addEventListener('click', () => {
                    const promptText = document.getElementById('finalPromptOutput').value;
                    if (promptText) {
                        try {
                            const tempInput = document.createElement('textarea');
                            tempInput.value = promptText;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            logProcess('최종 스타일 프롬프트가 클립보드에 복사되었습니다!', 'success');
                        } catch (err) {
                            logProcess('프롬프트 복사 실패. 수동으로 복사해 주세요.', 'error');
                        }
                    }
                });
            }
            
            // 3. 가사 프롬프트 복사 이벤트 [추가]
            if (copyLyricPromptBtn) {
                copyLyricPromptBtn.addEventListener('click', () => {
                    const promptText = document.getElementById('lyricPromptOutput').value;
                    if (promptText) {
                        try {
                            const tempInput = document.createElement('textarea');
                            tempInput.value = promptText;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            logProcess('최종 가사 프롬프트가 클립보드에 복사되었습니다!', 'success');
                        } catch (err) {
                            logProcess('가사 복사 실패. 수동으로 복사해 주세요.', 'error');
                        }
                    }
                });
            }

            // 4. 시각 프롬프트 복사 이벤트 [추가]
            if (copyVisualPromptBtn) {
                copyVisualPromptBtn.addEventListener('click', () => {
                    const promptText = document.getElementById('visualPromptOutput').value;
                    if (promptText) {
                        try {
                            const tempInput = document.createElement('textarea');
                            tempInput.value = promptText;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            logProcess('시각 프롬프트가 클립보드에 복사되었습니다!', 'success');
                        } catch (err) {
                            logProcess('시각 프롬프트 복사 실패. 수동으로 복사해 주세요.', 'error');
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
